#ifndef MF_OPS_DB_INC
#define MF_OPS_DB_INC

/**
 * MathFlow Operation Opcodes (The VM Instructions)
 */
#define MF_OPCODE_LIST \
    MF_OPCODE(NOOP, 0) \
    MF_OPCODE(ADD, 1) \
    MF_OPCODE(SUB, 2) \
    MF_OPCODE(MUL, 3) \
    MF_OPCODE(DIV, 4) \
    MF_OPCODE(MIN, 10) \
    MF_OPCODE(MAX, 11) \
    MF_OPCODE(ABS, 12) \
    MF_OPCODE(CLAMP, 13) \
    MF_OPCODE(STEP, 15) \
    MF_OPCODE(FLOOR, 20) \
    MF_OPCODE(CEIL, 21) \
    MF_OPCODE(SIN, 22) \
    MF_OPCODE(COS, 23) \
    MF_OPCODE(ATAN2, 24) \
    MF_OPCODE(SQRT, 25) \
    MF_OPCODE(POW, 26) \
    MF_OPCODE(SUM, 27) \
    MF_OPCODE(FMA, 29) \
    MF_OPCODE(MATMUL, 40) \
    MF_OPCODE(TRANSPOSE, 41) \
    MF_OPCODE(INVERSE, 42) \
    MF_OPCODE(DOT, 43) \
    MF_OPCODE(LENGTH, 44) \
    MF_OPCODE(NORMALIZE, 45) \
    MF_OPCODE(JOIN, 46) \
    MF_OPCODE(MIX, 47) \
    MF_OPCODE(SMOOTHSTEP, 48) \
    MF_OPCODE(LESS, 60) \
    MF_OPCODE(GREATER, 61) \
    MF_OPCODE(EQUAL, 62) \
    MF_OPCODE(NEQUAL, 63) \
    MF_OPCODE(LEQUAL, 64) \
    MF_OPCODE(GEQUAL, 65) \
    MF_OPCODE(AND, 80) \
    MF_OPCODE(OR, 81) \
    MF_OPCODE(XOR, 82) \
    MF_OPCODE(NOT, 83) \
    MF_OPCODE(SELECT, 100) \
    MF_OPCODE(GATHER, 262) \
    MF_OPCODE(CUMSUM, 270) \
    MF_OPCODE(COMPRESS, 280) \
    MF_OPCODE(COPY, 520) \
    MF_OPCODE(SLICE, 521) \
    MF_OPCODE(RESHAPE, 522)

/**
 * MathFlow Compiler Nodes (JSON Interface & Logic)
 * 
 * Format:
 * MF_OP(node_suffix, json_name, opcode_suffix, category, in_mask, out_mask, type_rule, shape_rule, access_rule, p1, p2, p3, p4, ktype, kexpr, karity)
 */
#define MF_OP_LIST \
    /* --- Special Nodes (Compiler Intrinsics) --- */ \
    MF_OP(CONST,   "Const",   NOOP,    MF_OP_CAT_SPECIAL, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SPECIAL,    MF_ACCESS_SPECIAL, "out", NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(INPUT,   "Input",   NOOP,    MF_OP_CAT_SPECIAL, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SPECIAL,    MF_ACCESS_SPECIAL, "out", NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(OUTPUT,  "Output",  COPY,    MF_OP_CAT_SPECIAL, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SPECIAL,    MF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(CALL,    "Call",    NOOP,    MF_OP_CAT_SPECIAL, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SPECIAL,    MF_ACCESS_SPECIAL, NULL,  NULL,  NULL,  NULL, MANUAL, NULL, 0) \
    MF_OP(COPY,    "Copy",    COPY,    MF_OP_CAT_SPECIAL, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Atomic Math (1:1 element mapping) --- */ \
    MF_OP(ADD,     "Add",     ADD,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va + vb), 2) \
    MF_OP(SUB,     "Sub",     SUB,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va - vb), 2) \
    MF_OP(MUL,     "Mul",     MUL,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va * vb), 2) \
    MF_OP(DIV,     "Div",     DIV,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va / vb), 2) \
    MF_OP(ABS,     "Abs",     ABS,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, fabsf(va), 1) \
    MF_OP(SIN,     "Sin",     SIN,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, sinf(va), 1) \
    MF_OP(COS,     "Cos",     COS,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, cosf(va), 1) \
    MF_OP(SQRT,    "Sqrt",    SQRT,    MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, sqrtf(va), 1) \
    MF_OP(FLOOR,   "Floor",   FLOOR,   MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, floorf(va), 1) \
    MF_OP(CEIL,    "Ceil",    CEIL,    MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "x",   NULL,  NULL,  NULL, AUTO, ceilf(va), 1) \
    MF_OP(POW,     "Pow",     POW,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "base","exp", NULL,  NULL, AUTO, powf(va, vb), 2) \
    MF_OP(ATAN2,   "Atan2",   ATAN2,   MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "y",   "x",   NULL,  NULL, AUTO, atan2f(va, vb), 2) \
    MF_OP(MIN,     "Min",     MIN,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va < vb ? va : vb), 2) \
    MF_OP(MAX,     "Max",     MAX,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va > vb ? va : vb), 2) \
    MF_OP(FMA,     "Fma",     FMA,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   "c",   NULL, AUTO, fmaf(va, vb, vc), 3) \
    MF_OP(CLAMP,   "Clamp",   CLAMP,   MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "x",   "min", "max", NULL, AUTO, fminf(fmaxf(va, vb), vc), 3) \
    MF_OP(STEP,    "Step",    STEP,    MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "edge","x",   NULL,  NULL, AUTO, (vb < va ? 0.0f : 1.0f), 2) \
    MF_OP(MIX,     "Mix",     MIX,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   "t",   NULL, AUTO, (va * (1.0f - vc) + vb * vc), 3) \
    MF_OP(SMOOTHSTEP,"SmoothStep",SMOOTHSTEP,MF_OP_CAT_ATOMIC,MF_TYPE_MASK_F32, MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S2, MF_ACCESS_LINEAR,  "edges","x",  NULL,  NULL, MANUAL, NULL, 2) \
    MF_OP(SELECT,  "Select",  SELECT,  MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT_2, MF_SHAPE_BROADCAST,MF_ACCESS_LINEAR,  "cond","true","false",NULL, AUTO, (va ? vb : vc), 3) \
    \
    /* --- Atomic Logic --- */ \
    MF_OP(LESS,    "Less",    LESS,    MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va < vb), 2) \
    MF_OP(GREATER, "Greater", GREATER, MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va > vb), 2) \
    MF_OP(EQUAL,   "Equal",   EQUAL,   MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va == vb), 2) \
    MF_OP(NEQUAL,  "NotEqual",NEQUAL,  MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va != vb), 2) \
    MF_OP(LEQUAL,  "LessEqual",LEQUAL, MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va <= vb), 2) \
    MF_OP(GEQUAL,  "GreaterEqual",GEQUAL, MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va >= vb), 2) \
    MF_OP(AND,     "And",     AND,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_LOGIC,   MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va && vb), 2) \
    MF_OP(OR,      "Or",      OR,      MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_LOGIC,   MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, (va || vb), 2) \
    MF_OP(XOR,     "Xor",     XOR,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_LOGIC,   MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_BROADCAST,  MF_ACCESS_LINEAR,  "a",   "b",   NULL,  NULL, AUTO, ((int)va != (int)vb), 2) \
    MF_OP(NOT,     "Not",     NOT,     MF_OP_CAT_ATOMIC,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_LOGIC,   MF_OUT_FORCE_U8,      MF_SHAPE_SAME_AS_S1, MF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, AUTO, (!va), 1) \
    \
    /* --- Reductions --- */ \
    MF_OP(REDUCE_SUM, "ReduceSum", SUM, MF_OP_CAT_REDUCTION, MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_SCALAR,    MF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(DOT,        "Dot",       DOT,     MF_OP_CAT_REDUCTION, MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_DOT,       MF_ACCESS_WINDOW,  "a",   "b",   NULL,  NULL, MANUAL, NULL, 2) \
    MF_OP(LENGTH,     "Length",    LENGTH,  MF_OP_CAT_REDUCTION, MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_DOT,       MF_ACCESS_WINDOW,  "x",   NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(SIZE,       "Size",      NOOP,    MF_OP_CAT_REDUCTION, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SCALAR,    MF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(CUMSUM,  "CumSum",  CUMSUM,  MF_OP_CAT_REDUCTION, MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_SAME_AS_S1, MF_ACCESS_GLOBAL, "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Accelerators --- */ \
    MF_OP(MATMUL,  "MatMul",    MATMUL,    MF_OP_CAT_ACCEL, MF_TYPE_MASK_NUMERIC, MF_TYPE_MASK_NUMERIC, MF_OUT_SAME_AS_INPUT, MF_SHAPE_MATMUL,    MF_ACCESS_WINDOW,  "a",   "b",   NULL,  NULL, MANUAL, NULL, 2) \
    MF_OP(INVERSE, "Inverse",   INVERSE,   MF_OP_CAT_ACCEL, MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_GLOBAL,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    \
    /* --- Memory & Layout --- */ \
    MF_OP(TRANSPOSE,"Transpose", TRANSPOSE, MF_OP_CAT_MEMORY, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_TRANSPOSE, MF_ACCESS_LINEAR,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(NORMALIZE,"Normalize", NORMALIZE, MF_OP_CAT_MEMORY, MF_TYPE_MASK_F32,     MF_TYPE_MASK_F32,     MF_OUT_FORCE_F32,     MF_SHAPE_SAME_AS_S1, MF_ACCESS_WINDOW,  "in",  NULL,  NULL,  NULL, MANUAL, NULL, 1) \
    MF_OP(JOIN,    "Join",      JOIN,      MF_OP_CAT_MEMORY, MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_JOIN,      MF_ACCESS_LINEAR,  "a",   "b",   "c",   "d",  MANUAL, NULL, 4) \
    MF_OP(GATHER,  "Gather",  GATHER,  MF_OP_CAT_MEMORY,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_GATHER,     MF_ACCESS_RANDOM,  "data", "indices", NULL, NULL, MANUAL, NULL, 2) \
    MF_OP(COMPRESS,"Filter",  COMPRESS,MF_OP_CAT_MEMORY,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SAME_AS_S1, MF_ACCESS_RANDOM,  "in",   "mask", NULL, NULL, MANUAL, NULL, 2) \
    MF_OP(SLICE,   "Slice",   SLICE,   MF_OP_CAT_MEMORY,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_SLICE,      MF_ACCESS_LINEAR,  "in",   "range", NULL, NULL, MANUAL, NULL, 2) \
    MF_OP(RESHAPE, "Reshape", RESHAPE, MF_OP_CAT_MEMORY,  MF_TYPE_MASK_ALL,     MF_TYPE_MASK_ALL,     MF_OUT_SAME_AS_INPUT, MF_SHAPE_RESHAPE,    MF_ACCESS_LINEAR,  "in",   "shape", NULL, NULL, MANUAL, NULL, 2)

#endif // MF_OPS_DB_INC
